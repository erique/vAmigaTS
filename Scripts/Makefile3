# Regression testing for FPGAArcade AMIGA cores

script_path := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

ASM=$(foreach item,$(wildcard */),$(wildcard $(addsuffix $(item:/=.s),$(item))))
EXE=$(ASM:.s=.run)
ROM=$(ASM:.s=.rom)
S68=$(ASM:.s=.s68)
INI=$(notdir $(ASM:.s=.ini))

VASM_FLAGS=-quiet -m68040 -I .. -I ../../../include -I /opt/amiga/m68k-amigaos/ndk-include

.PHONY: all clean

all: $(EXE) $(ROM) $(S68) $(INI)
	@echo > /dev/null
		
clean:
	@rm -f $(EXE) $(EXE:.run=.run.lst) $(ROM) $(ROM:.rom=.rom.lst) $(S68) $(S68:.s68=.s68.lst) $(INI)

%.run: %.s
	vasmm68k_mot -Fhunkexe                 $(VASM_FLAGS) $< -o $@ -L $(@D)/$(<F:.s=.run.lst)

%.rom: %.s
	vasmm68k_mot -DROM -Fbin  -cnop=0x0000 $(VASM_FLAGS) $< -o $@ -L $(@D)/$(<F:.s=.rom.lst)

%.s68: %.s
	vasmm68k_mot -DROM -Fsrec -cnop=0x0000 $(VASM_FLAGS) $< -o $@ -L $(@D)/$(<F:.s=.s68.lst)

%.ini:
	$(script_path)/createini.sh $@

# dummy
tiff:
#	@echo > /dev/null
